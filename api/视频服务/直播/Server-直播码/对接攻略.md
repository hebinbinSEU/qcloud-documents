# 直播码方案

## 方案概述

所谓“直播码”方案，是指直播频道的控制和管理完全由客户自主掌控，除了对接难度低之外，这套方案的定制空间也非常大，您可以：
（1）自主定义推流和播放地址：不需要到腾讯云申请推流频道，您可以按照约定格式自主定义推流和播放地址。
（2）自主管理直播频道的状态：腾讯云管理频道状态会给您带来诸多不便，比如您需要频繁地查询和同步每个频道的状态，而且腾讯云通过音视频数据流来监控频道状态会有“感知迟钝”的问题，直播码方案则是建议您自主管理频道状态，我们稍后会建议一直非常简单、高效并且可靠的解决方案。

在这套方案中，腾讯云将主要负责推流、转码、CDN分发、录制以及安全保护等功能，状态管理等部分则完全放开，您可以自主实现自己需要的业务逻辑，腾讯云会辅助提供一些基于音视频数据流的状态信息供您使用。
![](//mccdn.qcloud.com/static/img/aa6cf00971df050b3b781b126064131f/image.png)

## 对接攻略

### 推流地址
上图中的步骤一，主播在开始推流之前会先到您的后台服务器上申请推流地址，您可以按照如下格式为其分配一个：
![url](//mccdn.qcloud.com/static/img/719a807517e0e259e0b5e6ea664bc5d8/image.png)
- **bizid**: 
上图中的8888只是个示例数字，代表您在腾讯云分配到的bizid。
- **直播码**：
上图中8888_test_12345_test就是直播码了，这里唯一的要求就是以 “**bizid+下划线**” 作为前缀，剩下的部分您可以自由指定，只要确保不跟已经分配过的直播码冲突就行了，所以很多客户会选择用主播的用户id来作为直播码使用。
- **是否录制**：
record=flv 代表希望这个频道的直播内容在腾讯云录制成flv文件（目前仅支持flv一种格式，8月份增加对mp4和hls的支持），关于如何获取录制下来的文件我们会在接下来的录制章节中详细介绍。

### 直播列表
您可以自己根据需求维护直播频道列表，下图是一种推荐的实现方案：
![server](//mccdn.qcloud.com/static/img/56bb81fdbc4c5ab4cdea9448cbe3554c/image.png)

- **Step1: 发起直播**: 
>APP在发起直播时会向服务器请求一个推流URL，推流URL的生成方式我们在刚才已经介绍过了。
>
>您的服务器在返回APP一个推流URL的同时，也要向直播列表中添加一条记录。该记录中最重要的信息就是**直播码**和**用户ID**了（不少客户会直接拿用户ID作为房间号，这样后面管理很方便），除此之外，您还可以根据需要增加**封面图片地址**、**点赞人数**以及**正在观看人数**等点缀列表用的信息。

- **Step2: 结束直播**: 
> APP在结束直播时，同样需要通知一下服务器，这样服务器就可以第一时间把相应的记录删掉，或者设置为“主播已经离线”。

- **Step3: 漏网之鱼**: 
> 但Step2总有意外，比如主播的APP崩溃了，或者流量突然用完了，这类情况会让APP根本没有机会通知服务器该主播已经下线，这些情况如果不考虑，会在直播列表中残留一些 “僵尸频道”，有两种解决办法：
> 
> （方案一）您可以使用腾讯云的**消息通知服务**：您的服务器可以注册一个自己的**回调URL**给腾讯云，腾讯云会在您关心的频道在线状态有变化时通知给您。
> 
> （方案二）您可以通过腾讯云的状态查询接口（**Live_Statistic_QueryOnline**）定时地同步所有频道地在线状态，不过这种方案在要查询的频道数特别多的时候，响应速度不理想，同时调用频率也不能太快（一分钟一次为宜）。
>
> （方案三）也可以让在APP和服务器之间增加**心跳机制**：主播在推流时，每分钟向服务器发送一个心跳包，如果服务器连续三次没有收到心跳包，即判定主播已经离线。

### 视频播放
有了直播码，推流地址就可以拼装出来，播放地址也同样，下图是用直播码 **8888_test_12345_test** 拼装出来的rtmp flv 和 hls 三种播放地址：
![play](//mccdn.qcloud.com/static/img/cde137e65765cfaab367f9b36bc49f27/image.png)

在方案设计上，不推荐APP自己拼装，建议由服务器拼装完成后返送给APP，这是为后续扩展考虑，比如随着产品的发展，您可能要在地址里增加更多的参数和后缀来实现更多的功能特性。

APP拿到播放地址后就可以直接丢给腾讯云的RTMP SDK进行播放了。

### 录制回看
所谓录制回看，是指您可以把用户整个直播过程录制下来，然后作为点播视频用于回看，如下图：
![](//mccdn.qcloud.com/static/img/a8240c996be9eab19d5dc40b9e3df779/image.png)

**开启录制**：
> （方案一）直接指定所有直播的频道全部默认开启录制，付费项目，需要联系架构师开通。
> 
> （方案二）另一种是指定某个直播码开始录制，方案是在推流地址后面拼接**record**参数，比如record=flv。不过近期相关部门要求所有直播视频都要录存留底，所以这个特性意义不是很大。
> 
> 【特别注意】在腾讯云开启录制的前提是您已经开启**点播服务**，因为录制回看走的是腾讯云点播通道。

**文件获取**：
> （方案一）您可以使用腾讯云的**消息通知服务**：您的服务器可以注册一个自己的**回调URL**给腾讯云，腾讯云会在一个新的录制文件生成时通过这个URL通知给您。
> 
> （方案二）您可以通过腾讯云的文件查询接口（**Live_Tape_GetFilelist**）定时地查看是否有新的录制文件生成，不过这种方案在要查询的频道数特别多的时候，响应速度不理想，同时调用频率也不能太快（仅对刚结束的频道进行调用为宜），这种方案的实时性和可靠性不高，并不推荐频繁使用。

**视频回放**：
> 您的服务器获得录制的文件后，就可以生成播放URL了，APP拿到URL后交给RTMP SDK的点播播放模块就可以观看回放。

### 安全防盗链
#### 基本原理
所谓安全防盗链，是一种加了防盗链签名的URL，经过签名的URL能够跟腾讯云服务器的安全机制进行配合，可以将URL的使用权限定在您的APP上，恶意第三方拿到URL也不能使用和传播。

![](//mccdn.qcloud.com/static/img/b75148662176ff29eef17210b5d3d4f1/image.png)
上图都是典型的安全防盗URL，您会发现这些地址都有一个共同的特点，就是在原来的推流或者播放地址后拼接**txSecret**和**txTime**参数。

txSecret和txTime共同声明了该播放器的有效时间，比如5分钟，当这个地址在5分钟后被再次使用时，腾讯云将会判定其为过期地址而拒绝服务。

#### 适用场景
（1）推流 - 推流URL加防盗链的必要性极高，尤其是在直播码跟用户ID绑定的情况下，因为知名主播的直播码ID很容易被攻击者窃取，进而伪装主播进行抢占式推流，所以为推流URL增加防盗链签名，确保只有真正的主播才能在登录后拿到防盗链签名非常有必要。

（2）播放 - 播放URL加防盗链并不是100%必要的，只有在您的视频源是热门资源时（比如某个独家的赛事直播）才比较有价值，因为您要防止您的竞争对手拿到播放地址后在自家的APP里上架这个节目。播放地址防盗链引入后的副作用就是播放时可能需要申请防盗链签名，导致直播打开速度不稳定。

#### 签名生成
安全防盗链机制需要您的服务器和腾讯云后台协同才能完成，如下图：
![](//mccdn.qcloud.com/static/img/4ea1512fd335f68f30cca0a01e902966/image.png)

**step1 - 交换秘钥**
首先，您需要在官网的控制台，协商一个**加密密钥**，这个加密密钥用于在您的服务器上生成防盗链签名，由于腾讯云跟您持有同样的密钥，所以您生成的防盗链签名，腾讯云是可以进行解密确认的。

**step2 - 生成txTime**
签名中明文部分为txTime，含义是该链接的有效期，比如现在我当前的时间是2016-07-29 11:13:45，而且期望新生成的URL是在5分钟后即作废，那么txTime就可以设置为 2016-07-29 11:18:45。

不过这么长一串时间字符串不太经济，实际的txTime是把  2016-07-29 11:18:45 转换成Unix时间戳，也就是1469762325 （转换方式各种后台编程语言都由直接可用的时间函数来处理），然后转换成16进制，也就是 txTime=579ACB15。

**step3 - 生成txSecret**
txSecret的生成方法是 = **MD5(KEY+ stream_id + txTime)**，这里的 KEY 就是您在Step1中跟腾讯云交换的加密密钥，stream_id在本例中为 8888_test001，txTime为刚才计算的579ACB15，MD5即标准的MD5单向不可逆哈希算法。


### 事件通知
频道音视频数据流的推流状态、新的录制文件的生成、以及新的截图文件的生成，这类事件在腾讯云内部管理，但您的后台服务器可能也同样有获知的需求，这时可以使用腾讯云的事件通知服务获知这些事件。

您可以在控制台注册一个来自您后台服务器的回调URL给腾讯云，当有事件发生时，腾讯云会通过HTTP POST的方式将新的事件投递给您的服务器，事件内容以JSON格式组织。

下面这条消息的含义是直播流 8888_test001 持续一段时间没有音视频数据到腾讯云，判定为断流状态：
```json
{
    "t": 123456,"sign": "abcdeabcdeabcde","event_type": 0,"stream_id": "8888_test001","channel_id": "8888_test001"
}
```

其中如下字段是每一个事件消息中都包含的公共信息：

| 字段名称 | 类型 | 含义 |
|------------|-------------|---------|
| t           | string      | 有效时间（鉴权用） |
| sign      | string     | 安全签名 = MD5(KEY+t)（鉴权用） |
| event_type | int     | 事件类型   |
| stream_id | string     | 直播码   |
| channel_id | string     | 直播码   |

> **安全相关的 t 和 sign **
> 
> t 和 sign是两个用来鉴权的参数，其原理跟上面的安全防盗链如出一辙，只是这次检查方便了，安全防盗链是您来生成签名，然后交给腾讯云去检查，而此处则是腾讯云签名后交给您的后台系统校验，目的是防止有伪造腾讯云的攻击信息。
> 
> sign = MD5(KEY+ t) ，这里的安全依然依托一个双方协商好的密钥KEY，注意，这里的KEY跟安全防盗链的KEY可以不一样。

其中event_type有如下取值：
#### 推流和断流通知:
event_type = 0 代表断流  event_type = 1代表推流中，同时消息体会额外包含如下信息： 

| 字段名称  | 类型        | 含义        |
|---------|---------|---------|
| appname | string      | 推流路径  |
| app         | string      | 推流域名  |


#### 新录制文件通知：
event_type = 100 代表有新的录制文件生成，同时消息体会额外包含如下信息：

| 字段名称  | 类型        | 含义        |
|------------  |-------------|-------------|
| video_id   | string      | 点播用vid，在点播平台可以唯一定位一个点播视频文件  |
| video_url  | string      | 点播视频的下载地址  | 
| file_size  | string       | 文件大小  |
| start_time  | int      | 开始时间（unix时间戳，由于I帧干扰，暂时不能精确到秒级）  |
| end_time  | int       | 结束时间（unix时间戳，由于I帧干扰，暂时不能精确到秒级）  |

#### 新截图图片通知： 
event_type = 200 代表有新的截图图片生成，同时消息体会额外包含如下信息：

| 字段名称        | 类型       | 含义    |
|-------------------|-------------|---------|
| pic_url           | string      | 图片下载地址 |
| create_time   | int           |截图时间戳（unix时间戳，由于I帧干扰，暂时不能精确到秒级） |
