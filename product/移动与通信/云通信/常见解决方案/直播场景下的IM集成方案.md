## 1 直播场景下的IM需求
直播显然成为互联网当下最热的领域之一。对于任意一个直播系统，其无外乎都是由音视频系统与IM系统组成的。IM在直播系统中的主要作用是实现观众与主播、观众与观众之间的文字互动，互动内容包括普通文本消息、表情消息、点赞消息、进入房间消息、红包打赏消息等。

云通信针对直播领域的多人聊天需求提供了一套完整的解决方案：AVChatRoom。其基本能力包括：
- 基本的消息分发能力；
- 聊天室人数无上限；
- 支持Native APP和H5；
- 支持匿名（即无需注册账号并登录）接收消息。

除了最基本的消息分发能力，直播场景对IM还存在很多特殊需求，例如：如何下发用户加退群通知，并且确保在人数很多的情况下控制加退群通知的下发频率？如何在消息中携带发消息用户的身份信息，包括昵称、头像、身份、头衔等？如何对IM消息进行控制？云通信充分考虑了直播场景的这些特殊需求，并都给出了完整的解决方案。

云通信提供了Native APP和H5两种模式下的DEMO及其源码。基于云通信完善的能力以及丰富的参考样本，您可以花费最少的人力来完成直播系统中IM功能的集成并快速上线。

## 2 直播系统与IM系统的一般集成架构
![](//mccdn.qcloud.com/static/img/9de5ecdca24d44477b0e925156cc3588/image.png)
## 3 云通信直播场景DEMO
### 3.1 DEMO应用商店体验

**Native APP：**
云通信直播聊天室的相关DEMO在应用商店上架名为“随心播”，该APP是基于云通信以及腾讯云另一款产品“[互动直播](https://www.qcloud.com/product/ilvb.html)”开发而成。

Android下载地址（应用宝）：http://sj.qq.com/myapp/detail.htm?apkName=com.tencent.qcloud.suixinbo

应用宝下载二维码：
![](//mccdn.qcloud.com/static/img/55b65132442aa62465730bc0b20a1c7b/image.png)

iOS下载地址（AppStore）：https://itunes.apple.com/cn/app/sui-xin-bo/id1037944078?mt=8

二维码下载：
![](//mccdn.qcloud.com/static/img/25abd38be30a88cdaf6eedb975be02e7/image.png)

**H5 DEMO：**
为了确保H5 DEMO的简洁，我们仅在DEMO中集成了IM相关功能，并未包含视频功能。

官网demo体验地址：http://avc.qcloud.com/demo/webim/biggroup/mobile/index.html

demo二维码：
![](//mccdn.qcloud.com/static/img/a188f7fd653c8237b362a7adea1f63b1/image.png)

### 3.2 DEMO源码下载与代码导读

- [Android源码下载与导读](https://github.com/zhaoyang21cn/Android_Suixinbo)
- [iOS源码下载与导读](https://github.com/zhaoyang21cn/iOS_Suixinbo)
- [H5源码下载与导读](/doc/product/269/H5直播聊天室DEMO指引)

## 4 直播聊天室接入指引

直播场景的聊天室主要包括如下几大类核心操作：
- 创建聊天室（包括主播创建聊天室和APP后台通过REST API创建聊天室）；
- 观众申请加入聊天室（包括匿名加入聊天室）；
- 观众在聊天室中发言；
- APP接收聊天消息。

本小节我们将引导您如何从零开始在直播APP中集成聊天服务。

### 4.1 集成准备工作

在真正开始集成云通信SDK之前，您必须完成一些接入准备工作，包括：应用接入和用户体系集成。在完成这两步之后，您需要将SDK集成到您的APP中。然后才能开始调用直播聊天室相关的SDK接口。

**应用接入**
参见：[应用接入指引](/doc/product/269/应用接入指引)。

**用户体系集成**
云通信提供[独立模式](/doc/product/269/独立模式)和[托管模式](/doc/product/269/托管模式)两种用户体系集成。

如果您的APP自主维护用户的注册、用户身份的验证，则应当使用[独立模式](/doc/product/269/独立模式)；
如果您只是想快速开发一个APP原型，云通信可以为您提供一套符合业界通用安全标准的用户体系，用户的注册、用户身份的验证将全部由云通信提供，此时应当选用[托管模式](/doc/product/269/托管模式)。

**客户端集成**
客户端集成是将云通信的SDK集成到您的APP中，参见：
- [Android客户端集成](/doc/product/269/概述（Android%20SDK）)
- [iOS客户端集成](/doc/product/269/概述（iOS%20SDK）)
- [Windows C++客户端集成](/doc/product/269/概述（Windows%20SDK）)

接下来您便可以通过SDK提供的接口来实现直播聊天室。

### 4.2 创建直播聊天室
通过ImSDK创建直播聊天室，参见：
- [Android创建群组](/doc/product/269/群组管理（Android%20SDK）#3.1-.E5.88.9B.E5.BB.BA.E5.86.85.E7.BD.AE.E7.B1.BB.E5.9E.8B.E7.BE.A4.E7.BB.84)
- [iOS创建群组](/doc/product/269/群组管理（iOS%20SDK）#3.1-.E5.88.9B.E5.BB.BA.E5.86.85.E7.BD.AE.E7.B1.BB.E5.9E.8B.E7.BE.A4.E7.BB.84)
- [Windows C++创建群组](/doc/product/269/群组管理（Windows%20SDK）#3.1-.E5.88.9B.E5.BB.BA.E5.86.85.E7.BD.AE.E7.B1.BB.E5.9E.8B.E7.BE.A4.E7.BB.84)

通过REST API创建直播聊天室，参见：
- [REST API：创建群组](/doc/product/269/创建群组)。

### 4.3 申请加入聊天室
通过ImSDK申请加入聊天室，参见：
- [Android申请加群](/doc/product/269/群组管理（Android%20SDK）#3.5-.E7.94.B3.E8.AF.B7.E5.8A.A0.E5.85.A5.E7.BE.A4.E7.BB.84)
- [iOS申请加群](/doc/product/269/群组管理（iOS%20SDK）#3.5-.E7.94.B3.E8.AF.B7.E5.8A.A0.E5.85.A5.E7.BE.A4.E7.BB.84)
- [Windows C++申请加群](/doc/product/269/群组管理（Windows%20SDK）#3.5-.E7.94.B3.E8.AF.B7.E5.8A.A0.E5.85.A5.E7.BE.A4.E7.BB.84)

### 4.4 收发消息
通过ImSDK收发消息，参见：
- [Android消息收发](/doc/product/269/消息收发（Android%20SDK）)
- [iOS消息收发](/doc/product/269/消息收发（iOS%20SDK）)
- [Windows C++消息收发](/doc/product/269/消息收发（Windows%20SDK）)

通过REST API发送消息，参见：
- [REST API：在群组中发送普通消息](/doc/product/269/在群组中发送普通消息)

## 5 直播场景一些IM相关特殊需求的实现方法

### 5.1 聊天室成员进出通知
当聊天室中有用户进入或者离开时，云通信后台会下发成员进出通知。

新用户入群通知参见：
- [Android用户入群通知](/doc/product/269/群组管理（Android%20SDK）#8.1-.E7.94.A8.E6.88.B7.E5.8A.A0.E5.85.A5.E7.BE.A4.E7.BB.84.E9.80.9A.E7.9F.A5)
- [iOS用户入群通知](/doc/product/269/群组管理（iOS%20SDK）#8.1-.E7.94.A8.E6.88.B7.E5.8A.A0.E5.85.A5.E7.BE.A4.E7.BB.84)
- [Windows C++用户入群通知](/doc/product/269/群组管理（Windows%20SDK）#8.1-.E7.94.A8.E6.88.B7.E5.8A.A0.E5.85.A5.E7.BE.A4.E7.BB.84)

用户退群通知参见：
- [Android用户退群通知](/doc/product/269/群组管理（Android%20SDK）#8.2-.E7.94.A8.E6.88.B7.E9.80.80.E5.87.BA.E7.BE.A4.E7.BB.84)
- [iOS用户退群通知](/doc/product/269/群组管理（iOS%20SDK）#8.2-.E7.94.A8.E6.88.B7.E9.80.80.E5.87.BA.E7.BE.A4.E7.BB.84)
- [Windows C++用户退群通知](/doc/product/269/群组管理（Windows%20SDK）#8.2-.E7.94.A8.E6.88.B7.E9.80.80.E5.87.BA.E7.BE.A4.E7.BB.84)

云通信后台会对用户进出聊天室的消息进行频率控制。具体参见消息优先级与频率控制。

### 5.2 获取观看直播的用户列表
直播APP有时需要在屏幕中展示当前用户列表。单个AVChatRoom本身支持的用户数量无上限，但是当人数达到一定规模之后，群成员列表可能无法完整获取。但不论如何，群主、群管理员是一定能够完整获取到的。

通过ImSDK获取群成员列表，参见：
- [Android获取群成员列表](/doc/product/269/群组管理（Android%20SDK）#3.8-.E8.8E.B7.E5.8F.96.E7.BE.A4.E6.88.90.E5.91.98.E5.88.97.E8.A1.A8)
- [iOS获取群成员列表](/doc/product/269/群组管理（iOS%20SDK）#3.8-.E8.8E.B7.E5.8F.96.E7.BE.A4.E6.88.90.E5.91.98.E5.88.97.E8.A1.A8)
- [Windows C++获取群成员列表](/doc/product/269/群组管理（Windows%20SDK）#3.8-.E8.8E.B7.E5.8F.96.E7.BE.A4.E6.88.90.E5.91.98.E5.88.97.E8.A1.A8)

### 5.3 获取聊天室人数
参见：
- [Android获取群组资料](/doc/product/269/群组管理（Android%20SDK）#4.-.E8.8E.B7.E5.8F.96.E7.BE.A4.E7.BB.84.E8.B5.84.E6.96.99)
- [iOS获取群组资料](/doc/product/269/群组管理（iOS%20SDK）#4.-.E8.8E.B7.E5.8F.96.E7.BE.A4.E8.B5.84.E6.96.99)
- [Windows C++获取群组资料](/doc/product/269/群组管理（Windows%20SDK）#4.-.E8.8E.B7.E5.8F.96.E7.BE.A4.E8.B5.84.E6.96.99)

**特别注意：**
- 直播聊天室支持的用户数量无上限。当成员数量达到一定规模时，成员数量的统计可能会存在一定误差。
- 通过H5不登录接收IM消息的用户也会被计入聊天室人数中。但由于这些用户没有登录，不可能在用户列表中得到展示。

### 5.4 在聊天室中下发自定义消息
云通信的消息原生支持文本、图片、语音、表情等。如果APP存在一些特殊的消息需求（例如点赞消息、红包消息等），可以通过云通信的自定义消息实现。

通过ImSDK发送自定义消息，参见：
- [Android发送自定义消息](/doc/product/269/消息收发（Android%20SDK）#1.8-.E8.87.AA.E5.AE.9A.E4.B9.89.E6.B6.88.E6.81.AF.E5.8F.91.E9.80.81)
- [iOS发送自定义消息](/doc/product/269/消息收发（iOS%20SDK）#1.7-.E8.87.AA.E5.AE.9A.E4.B9.89.E6.B6.88.E6.81.AF.E5.8F.91.E9.80.81)
- [Windows C++发送自定义消息](/doc/product/269/消息收发（Windows%20SDK）#1.7-.E8.87.AA.E5.AE.9A.E4.B9.89.E6.B6.88.E6.81.AF.E5.8F.91.E9.80.81)

通过REST API发送自定义消息，参见：
- [REST API：在群组中发送普通消息](/doc/product/269/在群组中发送普通消息#2.7-.E8.AF.B7.E6.B1.82.E5.8C.85.E7.A4.BA.E4.BE.8B)

**特别注意：**
1. 云通信的脏字过滤功能不会对自定义字段中的数据进行检测。因此，APP最好在设计之初就确保将需要进行脏字过滤的文本放到消息的TextElem中。
1. 为方便调试，建议APP使用JSON来组织自定义字段。不建议使用二进制数据。


### 5.5 消息优先级与频率控制
当直播聊天室中的人数较多时，发消息的用户可能会非常多，导致一秒之内产生的消息量非常大。消息频率过高，不仅会导致云通信服务后台压力过重，也会给前台APP的渲染造成压力。同时，如果屏幕消息卷动速率过快，还可能导致用户无法看清消息。

基于上述考虑，云通信会对单个聊天室中的消息进行频率控制，默认控制策略为40条/秒。超过该频率的消息将会被丢弃，不会得到下发。

为保证关键消息得到下发，而仅丢弃不重要的消息，云通信引入了消息优先级的概念。频率控制策略为：对一个时间窗内的消息依照优先级进行排序，选择优先级较高的N条消息进行下发（默认N为40），其余消息将被丢弃。

消息优先级共分四级，从最高到最低分别是：
- High
- Normal
- Low
- Lowest

如果APP通过ImSDK或者REST API发送消息时没有指定优先级，默认消息优先级为Normal；成员变更通知的消息优先级默认为Lowest。

我们建议：红包打赏消息，可以将优先级设置为High；点赞类消息，可以将优先级设置为Low。如果需要对不同优先级的消息设置频率控制，可以根据[工单模板](/doc/product/269/云通信配置变更需求工单#2.5-.E7.BE.A4.E7.BB.84.E4.B8.8D.E5.90.8C.E4.BC.98.E5.85.88.E7.BA.A7.E7.9A.84.E6.B6.88.E6.81.AF.E7.9A.84.E9.A2.91.E7.8E.87.E6.8E.A7.E5.88.B6)提交工单进行申请。

### 5.6 聊天室禁言与全局禁言
某些用户可能会在聊天室中发一些广告或者对主播恶语相加。此时可以考虑将该用户禁言。禁言分为两个维度：
- 群组维度的禁言：用户在群内无法发言，即使退群再加群也不例外（群主和管理员具备此权限）；
- 全局维度的禁言：用户在所有群组中都不能发言，同时也不能发送单聊消息（仅APP管理员具备该权限，即将推出）。

通过ImSDK实现群内禁言，参见：
- [Android对群成员进行禁言](/doc/product/269/群组管理（Android%20SDK）#5.8-.E5.AF.B9.E7.BE.A4.E6.88.90.E5.91.98.E8.BF.9B.E8.A1.8C.E7.A6.81.E8.A8.80)
- [iOS对群成员进行禁言](/doc/product/269/群组管理（iOS%20SDK）#5.8-.E5.AF.B9.E7.BE.A4.E6.88.90.E5.91.98.E8.BF.9B.E8.A1.8C.E7.A6.81.E8.A8.80)
- [Windows C++对群成员进行禁言](/doc/product/269/群组管理（Windows%20SDK）#5.7-.E4.BF.AE.E6.94.B9.E7.BE.A4.E5.91.98.E4.BF.A1.E6.81.AF)

通过REST API实现群内禁言，参见：
- [REST API：批量禁言和取消禁言](/doc/product/269/批量禁言和取消禁言)

通过REST API获取群内被禁言用户的列表，参见：
- [REST API：获取群组被禁言用户列表](/doc/product/269/获取群组被禁言用户列表)

### 5.7 敏感词（脏字）过滤
所谓脏字过滤，是指APP可以在云通信后台配置一批敏感词，如果云通信后台在用户发送的消息中检测到这些敏感词，则拒绝下发该消息，并向发送者返回错误码80001。

脏字的增删查改参见：
- [REST API：查询APP自定义脏字](/doc/product/269/查询APP自定义脏字)
- [REST API：添加APP自定义脏字](/doc/product/269/添加APP自定义脏字)
- [REST API：删除APP自定义脏字](/doc/product/269/删除APP自定义脏字)

注意：
1. 云通信已经默认配置了政治类、色情类的脏字，能够满足这两方面的大多数过滤需求，APP只需要配置业务场景相关的脏字即可。例如，电商类APP只需要配置“假货”、“刷单”等商业类脏字即可。
2. 默认情况下，云通信后台只会对消息格式中的文本消息进行脏字过滤（TIMTextElem，参见[消息格式描述](/doc/product/269/消息格式描述)），如果APP使用自定义消息格式（TIMCustomElem，参见[消息格式描述](/doc/product/269/消息格式描述)），云通信后台无法进行过滤。因此，APP最好在设计之初就确保将需要进行脏字过滤的文本放到TIMCustomElem中。对于APP已经使用了自定义消息格式，且已经上线，可以联系云通信客服，将消息格式提供给云通信的技术人员。云通信后台可以据此解析APP的自定义消息中的文本信息，并进行脏字过滤。

### 5.8 其他消息控制策略
除了禁言与脏字过滤之外，云通信还提供了其他消息控制策略，例如群内发言之前回调。另外，如果您的控制策略较为特殊，可以联系云通信客服提出需求，云通信可以为您定制开发消息控制策略。

**群内发言之前回调：**

所谓群内发言之前回调，即云通信后台在收到用户的发消息请求之后、将该消息下发给群成员之前，向APP后台发起http/https回调，并根据APP后台的应答结果来判定是否应当下发该消息。这是APP后台干涉云通信消息下发逻辑的方式之一。

除此之外，APP后台在收到回调请求之后，亦可对用户发送的消息内容进行修改并返回给云通信，云通信将使用修改之后的信息进行下发。

注意：在发起第三方回调时，云通信要求APP后台必须在2秒之内给出应答，如果没有收到应答，云通信不会进行重试，会直接将消息下发给群成员。

整体逻辑如下图所示：
![](http://mccdn.qcloud.com/static/img/3708a8d1c1397cfb112c78ef9125fb24/image.png)

参见：
- [第三方回调简介](/doc/product/269/第三方回调简介)
- [第三方回调接入指引](/doc/product/269/第三方回调接入指引)
- [群内发言之前回调](/doc/product/269/群内发言之前回调)

### 5.9 在消息中携带用户身份信息
群消息在下发给客户端时，除了会携带消息内容本身，还会携带消息发送者的信息，默认会携带如下字段：发送者的昵称、发送者的头像、发送者在群内的群名片。如果您的APP在云通信中配置了用户维度的自定义字段、[群维度的自定义字段](/doc/product/269/群组系统#6-.E8.87.AA.E5.AE.9A.E4.B9.89.E5.AD.97.E6.AE.B5)（AVChatRoom不支持群成员维度的自定义字段），亦可在消息中携带这些信息（不会默认携带自定义字段，如有需要请根据[工单模板](/doc/product/269/云通信配置变更需求工单#2.6-.E7.BE.A4.E4.B8.8B.E8.A1.8C.E6.B6.88.E6.81.AF.E5.B8.A6.E8.87.AA.E5.AE.9A.E4.B9.89.E5.AD.97.E6.AE.B5)提交工单进行处理）。

如果要在消息中携带发送者昵称、头像，必须将这两个信息导入云通信的用户资料。

通过APP设置设置用户资料，参见：
- [Android用户资料](/doc/product/269/用户资料与关系链（Android%20SDK）)
- [iOS用户资料](/doc/product/269/用户资料与关系链（iOS%20SDK）)
- [Windows C++用户资料](/doc/product/269/用户资料与关系链（Windows%20SDK）)
- [Web用户资料](/doc/product/269/用户资料（Web%20SDK）)

通过REST API查询/设置用户资料，参见：
- [REST API：拉取用户资料](/doc/product/269/拉取资料)
- [REST API：设置用户资料](/doc/product/269/设置资料)

除此之外，使用独立模式的APP还可以在通过REST API导入账号的同时设置用户资料，参见：
- [REST API：独立模式账号同步](/doc/product/269/独立模式账号同步接口)

### 5.10 压力测试
即将推出压力测试工具。

## 6 从其他群组形态迁移到直播聊天室（AVChatRoom）
直播聊天室（AVChatRoom）在ImSDK 1.9.0正式推出。在此之前，某些直播类APP可能会使用其他种类的群组（例如ChatRoom）来实现直播场景的IM能力。

与其他种类的群组相比，AVChatRoom的核心优势在于：
1. 群组成员无上限；
1. 支持用户不登录接收消息（H5场景）；
1. 消息可靠性更高、客户端开销更低。

因此，我们建议使用其他群组形态的迁移到AVChatRoom。云通信SDK与后台已经做了充分的兼容逻辑。APP（包括ImSDK和REST API）唯一需要做的事情是：在创建群组时，指定群组形态为AVChatRoom。除此之外，其他逻辑一概不需要改变。即使对于1.9.0之前的老版本客户端，依然可以申请加入到AVChatRoom并接收消息。

## 7 其他通信相关能力
### 7.1 全员消息推送
直播场景下，有时候APP后台会需要向全局用户下发消息，俗称“大喇叭消息”。云通信专门提供了全员推送服务。

除了全员推送之外，云通信还支持向全部用户中满足特定条件的用户推送消息。

通过REST API发起推送，参见：
[消息推送服务](/doc/product/269/消息推送服务)。

ImSDK 接收消息都是通过统一回调接口 onNewMessage 返回，通过 onNewMessage 回调获得消息后，能根据消息获取相应的会话。

参见：
- [Android 新消息通知](/doc/product/269/初始化（Android%20SDK）#2-.E6.96.B0.E6.B6.88.E6.81.AF.E9.80.9A.E7.9F.A5)
- [iOS 新消息通知](/doc/product/269/初始化（iOS%20SDK）#2.-.E6.96.B0.E6.B6.88.E6.81.AF.E9.80.9A.E7.9F.A5)
- [Windows 新消息通知](/doc/product/269/初始化（Windows%20%20SDK）#4.-.E6.96.B0.E6.B6.88.E6.81.AF.E9.80.9A.E7.9F.A5)
- [WebSDK 初始化新消息回调](/doc/product/269/初始化（Web%20SDK）)

### 7.2 面向单个/一批用户的系统通知
如果APP后台需要想单个/一批用户发送系统通知，可以参考如下两个接口：
- [REST API 发送消息](/doc/product/269/单发单聊消息)
- [REST API：批量发单聊消息](/doc/product/269/批量发单聊消息)